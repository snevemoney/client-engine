generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
}

model Lead {
  id           String     @id @default(cuid())
  title        String
  source       String
  sourceUrl    String?
  contentHash  String?    @unique
  status       LeadStatus @default(NEW)
  description  String?    @db.Text
  budget       String?
  timeline     String?
  platform     String?
  techStack    String[]
  contactName  String?
  contactEmail String?
  score        Int?
  scoreReason  String?    @db.Text
  enrichedAt        DateTime?
  scoredAt          DateTime?
  proposalSentAt    DateTime?
  approvedAt        DateTime?
  buildStartedAt    DateTime?
  buildCompletedAt  DateTime?
  dealOutcome       String?   // "won" | "lost" | null
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  tags         String[]
  // ----- Sales operating system (PBD 6 steps) -----
  salesStage             String?   // PROSPECTING | APPROACH_CONTACT | PRESENTATION | FOLLOW_UP | REFERRAL | RELATIONSHIP_MAINTENANCE
  nextContactAt          DateTime?
  lastContactAt          DateTime?
  followUpCount          Int       @default(0)
  followUpCadenceDays    Int?
  permissionToFollowUp   Boolean?
  personalDetails        String?   @db.Text
  leadSourceType         String?   // warm | network_referral
  leadSourceChannel      String?   // linkedin | email | event | website | friend | existing_client | other
  introducedBy          String?
  referralAskStatus     String?   // not_asked | asked | received
  referralAskAt         DateTime?
  referralCount         Int       @default(0)
  referralNames         String?   @db.Text
  sourceDetail          String?   @db.Text  // e.g. "Montreal meetup", "LinkedIn post: AI ops audit"
  lastTouchType         TouchType?
  followUpStage         Int       @default(0)
  detailScore           Int?      // 0-100 how well we captured their details
  relationshipStatus    String?   // active | dormant | nurture
  relationshipLastCheck DateTime?
  touchCount            Int       @default(0)
  artifacts             Artifact[]
  project               Project?

  @@index([status])
  @@index([createdAt])
  @@index([source])
  pipelineRuns          PipelineRun[]
  touches               LeadTouch[]
  referralsReceived     LeadReferral[] @relation("ReferralsForLead")
  attributions          LeadAttribution[]
  buildTasksLinked      BuildTask[]
  reusableAssetLogs     ReusableAssetLog[]
}

enum LeadStatus {
  NEW
  ENRICHED
  SCORED
  APPROVED
  REJECTED
  BUILDING
  SHIPPED
}

enum LeadSourceType {
  COLD
  WARM
  REFERRAL
  CONTENT
  NETWORKING
  INBOUND
  OTHER
}

enum ProspectingChannel {
  LINKEDIN
  NETWORKING_EVENT
  EMAIL_OUTREACH
  REFERRAL_INTRO
  REFERRAL
  INSTAGRAM
  YOUTUBE
  TIKTOK
  TWITTER
  X
  THREADS
  NEWSLETTER
  DIRECT_MESSAGE
  WEBSITE_INBOUND
  OTHER
}

enum TouchType {
  EMAIL
  CALL
  LINKEDIN_DM
  MEETING
  FOLLOW_UP
  REFERRAL_ASK
  CHECK_IN
}

model Artifact {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type      String
  title     String
  content   String   @db.Text
  meta      Json?
  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([leadId, createdAt])
}

model Project {
  id           String   @id @default(cuid())
  leadId       String?  @unique
  lead         Lead?    @relation(fields: [leadId], references: [id])
  slug         String   @unique
  name         String
  description  String?  @db.Text
  demoUrl      String?
  repoUrl      String?
  repoPath     String?
  techStack    String[]
  screenshots  String[]
  status       String   @default("draft")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  reusableAssetLogs ReusableAssetLog[]
}

model PipelineRun {
  id            String    @id @default(cuid())
  leadId        String
  lead          Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  status        String    @default("running")
  startedAt     DateTime  @default(now())
  finishedAt    DateTime?
  success       Boolean?
  error         String?   @db.Text
  retryCount    Int       @default(0)
  lastErrorCode String?
  lastErrorAt   DateTime?
  steps         PipelineStepRun[]

  @@index([leadId])
  @@index([leadId, startedAt])
}

model PipelineStepRun {
  id                 String      @id @default(cuid())
  runId              String
  run                PipelineRun  @relation(fields: [runId], references: [id], onDelete: Cascade)
  stepName           String
  startedAt          DateTime    @default(now())
  finishedAt        DateTime?
  success           Boolean?
  tokensUsed        Int?
  costEstimate      Float?
  outputArtifactIds String[]     @default([])
  notes             String?     @db.Text
}

model LeadTouch {
  id              String   @id @default(cuid())
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type            TouchType
  direction       String   // outbound | inbound
  summary         String   @db.Text
  scriptUsed      String?
  outcome         String?
  nextAction      String?  @db.Text
  nextTouchAt     DateTime?
  detailsCaptured Json?
  createdAt       DateTime @default(now())

  @@index([leadId])
}

model LeadReferral {
  id                String   @id @default(cuid())
  sourceLeadId      String
  sourceLead        Lead     @relation("ReferralsForLead", fields: [sourceLeadId], references: [id], onDelete: Cascade)
  referredName      String
  referredCompany   String?
  referredContact   String?  @db.Text
  referralQuality   Int?
  status            String   @default("new") // new | contacted | qualified | proposal_sent | won | lost
  convertedLeadId   String?
  notes             String?  @db.Text
  createdAt         DateTime @default(now())

  @@index([sourceLeadId])
}

model ContentAsset {
  id              String    @id @default(cuid())
  platform        String    // linkedin, youtube, tiktok, instagram
  title           String?
  url             String?   @db.Text
  publishedAt     DateTime?
  topicTag        String?
  format          String?
  ctaType         String?
  views           Int?
  comments        Int?
  inboundLeads    Int       @default(0)
  qualifiedLeads  Int       @default(0)
  wonDeals        Int       @default(0)
  cashCollected   Float     @default(0)
  notes           String?   @db.Text
  createdAt       DateTime  @default(now())
}

model LeadAttribution {
  id             String   @id @default(cuid())
  leadId         String
  lead           Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  contentAssetId String?
  sourceChannel  String?
  confidence     Int?
  note           String?  @db.Text
  createdAt      DateTime @default(now())

  @@index([leadId])
}

// ----- Client Acquisition Engine (Tom-style freelancer marketing) -----

/** Owned audience (newsletter/blog) ledger: manual snapshots for health + trend. */
model OwnedAudienceLedger {
  id                  String   @id @default(cuid())
  at                  DateTime // snapshot date (e.g. end of week)
  subscribers         Int      @default(0)
  sends               Int      @default(0)
  replies             Int      @default(0)
  clicks              Int      @default(0)
  inquiriesInfluenced Int      @default(0)
  note                String?  @db.Text
  createdAt           DateTime @default(now())

  @@index([at])
}

/** Networking events with quality score inputs. */
model NetworkingEvent {
  id                   String   @id @default(cuid())
  name                 String
  eventDate            DateTime
  audienceType         String?  // e.g. "tech founders", "indie devs"
  relevanceScore       Int?     // 1-10
  contactsMade         Int      @default(0)
  followUpsSent        Int      @default(0)
  opportunitiesCreated Int     @default(0)
  revenue             Float?
  notes               String?  @db.Text
  createdAt            DateTime @default(now())
}

/** NDA-safe proof assets: anonymized patterns, lessons, outcomes. No client names. */
model ProofAsset {
  id                    String   @id @default(cuid())
  anonymizedCasePattern String   @db.Text
  lessonLearned         String?  @db.Text
  outcomeSummary        String?  @db.Text
  processImprovement    String?  @db.Text
  channelContentIdeas   String[] @default([]) // e.g. "LinkedIn post on X"
  linkedArtifactIds     String[] @default([]) // proposal/content artifact IDs
  createdAt             DateTime @default(now())
}

// ----- Build Ops / Code Ops (Cloud Agent queue) -----

/** Build task: bug, feature, refactor, guardrail, template. Trackable work for Cursor Cloud Agent. */
model BuildTask {
  id                   String    @id @default(cuid())
  title                String
  type                 String    // bug | feature | refactor | guardrail | template
  priority             String    @default("medium") // low | medium | high
  linkedLeadId         String?
  linkedLead           Lead?     @relation(fields: [linkedLeadId], references: [id])
  linkedCriticismItem  String?   @db.Text  // optional ref to weekly critic item
  expectedOutcome      String?   @db.Text
  status               String    @default("todo") // todo | in_progress | review | done
  cursorPrompt         String?   @db.Text  // exact prompt given to Cloud Agent
  prSummary            String?   @db.Text  // what changed
  humanApproved        Boolean   @default(false)
  businessImpact       String?   // Acquire | Deliver | Improve
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([status])
  @@index([type])
}

// ----- Reusable Asset Log (leverage from delivered work) -----

/** Log of reusable leverage extracted from a delivered client project. Human-driven. */
model ReusableAssetLog {
  id               String   @id @default(cuid())
  leadId           String?
  lead             Lead?    @relation(fields: [leadId], references: [id])
  projectId        String?
  project          Project? @relation(fields: [projectId], references: [id])
  assetType        String   // template | component | workflow | prompt_pack | checklist | case_study | prompt_pattern | sales_script | sop_playbook
  label            String?  @db.Text  // short name or "None" when none extracted
  reasonNone       String?  @db.Text  // when no asset: reason (e.g. "one-off, not reusable")
  notes            String?  @db.Text  // what makes it reusable
  reusabilityScore Int?     // 1-5
  whereStored      String?  @db.Text  // path, link, or "Notion doc X"
  canProductize    String?  // yes | no | maybe
  createdAt        DateTime @default(now())

  @@index([leadId])
  @@index([projectId])
  @@index([createdAt])
}

// ----- Operator Copilot: approved action execution log -----

/** Log of actions executed by the operator copilot (chat approve â†’ execute). */
model OperatorActionRun {
  id             String    @id @default(cuid())
  actionName     String
  input          Json      @default("{}")
  approvedBy     String    // User id from session
  status         String    // queued | running | success | fail
  resultSummary  String?   @db.Text
  error          String?   @db.Text
  createdAt      DateTime  @default(now())

  @@index([actionName])
  @@index([createdAt])
}

// ----- YouTube Ingestion Pipeline -----

/** YouTube source: a video or channel that was submitted for ingestion. */
model YouTubeSource {
  id             String    @id @default(cuid())
  type           String    // video | channel
  url            String
  normalizedUrl  String
  externalId     String    @unique // videoId or channelId
  title          String?
  channelName    String?
  channelId      String?
  metadataJson   Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  ingestJobs     YouTubeIngestJob[]
  transcripts    YouTubeTranscript[]

  @@index([type])
  @@index([externalId])
}

/** YouTube ingest job: tracks a single ingest attempt (video or channel batch). */
model YouTubeIngestJob {
  id              String    @id @default(cuid())
  sourceType      String    // video | channel
  sourceId        String?
  source          YouTubeSource? @relation(fields: [sourceId], references: [id])
  status          String    @default("PENDING") // PENDING | FETCHING | TRANSCRIBED | FAILED_TRANSCRIPT | READY_FOR_REVIEW | PROMOTED_TO_PLAYBOOK | REJECTED | KNOWLEDGE_ONLY
  attempts        Int       @default(0)
  providerUsed    String?
  lastError       String?   @db.Text
  runSummaryJson  Json?
  queuedAt        DateTime  @default(now())
  startedAt       DateTime?
  completedAt     DateTime?

  @@index([status])
  @@index([sourceId])
  @@index([queuedAt])
}

/** YouTube transcript: the actual transcript content + metadata for a video. */
model YouTubeTranscript {
  id                    String    @id @default(cuid())
  videoId               String    @unique
  channelId             String?
  sourceUrl             String
  title                 String?
  transcriptText        String    @db.Text
  transcriptSegmentsJson Json?
  language              String?
  durationSeconds       Int?
  publishedAt           DateTime?
  providerUsed          String
  transcriptHash        String?
  transcriptStatus      String    @default("TRANSCRIBED") // TRANSCRIBED | FAILED_TRANSCRIPT
  failureReason         String?   @db.Text
  metadataJson          Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  sourceRecord          YouTubeSource? @relation(fields: [videoId], references: [externalId])
  learningProposals     LearningProposal[]

  @@index([channelId])
  @@index([transcriptStatus])
  @@index([providerUsed])
}

/** Learning proposal: human-gated proposal derived from a transcript. No auto-apply. */
model LearningProposal {
  id                    String    @id @default(cuid())
  transcriptId          String
  transcript            YouTubeTranscript @relation(fields: [transcriptId], references: [id])
  summary               String    @db.Text
  extractedPointsJson   Json?
  category              String?   // sales | operations | client_delivery | positioning | ai_tooling | automation | leadership | hiring | offer_design | follow_up_retention
  systemArea            String?   // Acquire | Deliver | Improve
  contradictionFlagsJson Json?
  proposedActionsJson   Json?
  producedAssetType     String?   // proposal_template | sales_script | followup_script | objection_handling | delivery_checklist | reusable_component | case_study_angle | positioning_note | knowledge_only
  expectedImpact        String?   // acquire | deliver | improve
  revenueLink           String?   @db.Text
  status                String    @default("READY_FOR_REVIEW") // READY_FOR_REVIEW | PROMOTED_TO_PLAYBOOK | REJECTED | KNOWLEDGE_ONLY
  reviewerNotes         String?   @db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([status])
  @@index([transcriptId])
  @@index([category])
  @@index([systemArea])
}
