generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
}

model Lead {
  id           String     @id @default(cuid())
  title        String
  source       String
  sourceUrl    String?
  contentHash  String?    @unique
  status       LeadStatus @default(NEW)
  description  String?    @db.Text
  budget       String?
  timeline     String?
  platform     String?
  techStack    String[]
  contactName  String?
  contactEmail String?
  score        Int?
  scoreReason  String?    @db.Text
  enrichedAt        DateTime?
  scoredAt          DateTime?
  proposalSentAt    DateTime?
  approvedAt        DateTime?
  buildStartedAt    DateTime?
  buildCompletedAt  DateTime?
  dealOutcome       String?   // "won" | "lost" | null
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  tags         String[]
  // ----- Sales operating system (PBD 6 steps) -----
  salesStage             String?   // PROSPECTING | APPROACH_CONTACT | PRESENTATION | FOLLOW_UP | REFERRAL | RELATIONSHIP_MAINTENANCE
  nextContactAt          DateTime?
  lastContactAt          DateTime?
  followUpCount          Int       @default(0)
  followUpCadenceDays    Int?
  permissionToFollowUp   Boolean?
  personalDetails        String?   @db.Text
  leadSourceType         String?   // warm | network_referral
  leadSourceChannel      String?   // linkedin | email | event | website | friend | existing_client | other
  introducedBy          String?
  referralAskStatus     String?   // not_asked | asked | received
  referralAskAt         DateTime?
  referralCount         Int       @default(0)
  referralNames         String?   @db.Text
  sourceDetail          String?   @db.Text  // e.g. "Montreal meetup", "LinkedIn post: AI ops audit"
  lastTouchType         TouchType?
  followUpStage         Int       @default(0)
  detailScore           Int?      // 0-100 how well we captured their details
  relationshipStatus    String?   // active | dormant | nurture
  relationshipLastCheck DateTime?
  touchCount            Int       @default(0)
  // ----- Sales Driver (reason → result → deadline, qualification, next action) -----
  driverType            String?   // survival | status | freedom | cause | competition | enemy | unknown
  driverReason          String?   @db.Text
  desiredResult         String?   @db.Text
  resultDeadline        DateTime?
  nextAction            String?   @db.Text
  nextActionDueAt       DateTime?
  proofAngle            String?   @db.Text
  scorePain             Int?      // 0-2
  scoreUrgency          Int?
  scoreBudget           Int?
  scoreResponsiveness   Int?
  scoreDecisionMaker    Int?
  scoreFit              Int?
  artifacts             Artifact[]
  project               Project?

  @@index([status])
  @@index([createdAt])
  @@index([source])
  @@index([nextActionDueAt])
  @@index([driverType])
  pipelineRuns          PipelineRun[]
  touches               LeadTouch[]
  referralsReceived     LeadReferral[] @relation("ReferralsForLead")
  attributions          LeadAttribution[]
  buildTasksLinked      BuildTask[]
  reusableAssetLogs     ReusableAssetLog[]
  promotedFromIntake    IntakeLead?
  proofCandidates       ProofCandidate[]
  proposalCount         Int               @default(0)
  proposals             Proposal[]
  deliveryProjects      DeliveryProject[]
}

enum LeadStatus {
  NEW
  ENRICHED
  SCORED
  APPROVED
  REJECTED
  BUILDING
  SHIPPED
}

enum LeadSourceType {
  COLD
  WARM
  REFERRAL
  CONTENT
  NETWORKING
  INBOUND
  OTHER
}

enum ProspectingChannel {
  LINKEDIN
  NETWORKING_EVENT
  EMAIL_OUTREACH
  REFERRAL_INTRO
  REFERRAL
  INSTAGRAM
  YOUTUBE
  TIKTOK
  TWITTER
  X
  THREADS
  NEWSLETTER
  DIRECT_MESSAGE
  WEBSITE_INBOUND
  OTHER
}

enum TouchType {
  EMAIL
  CALL
  LINKEDIN_DM
  MEETING
  FOLLOW_UP
  REFERRAL_ASK
  CHECK_IN
  CALL_BOOKED
  CALL_COMPLETED
}

model Artifact {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type      String
  title     String
  content   String   @db.Text
  meta      Json?
  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([leadId, createdAt])
}

model Project {
  id           String   @id @default(cuid())
  leadId       String?  @unique
  lead         Lead?    @relation(fields: [leadId], references: [id])
  slug         String   @unique
  name         String
  description  String?  @db.Text
  demoUrl      String?
  repoUrl      String?
  repoPath     String?
  techStack    String[]
  screenshots  String[]
  status       String   @default("draft")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  reusableAssetLogs ReusableAssetLog[]
}

model PipelineRun {
  id            String    @id @default(cuid())
  leadId        String
  lead          Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  status        String    @default("running")
  startedAt     DateTime  @default(now())
  finishedAt    DateTime?
  success       Boolean?
  error         String?   @db.Text
  retryCount    Int       @default(0)
  lastErrorCode String?
  lastErrorAt   DateTime?
  steps         PipelineStepRun[]

  @@index([leadId])
  @@index([leadId, startedAt])
}

model PipelineStepRun {
  id                 String      @id @default(cuid())
  runId              String
  run                PipelineRun  @relation(fields: [runId], references: [id], onDelete: Cascade)
  stepName           String
  startedAt          DateTime    @default(now())
  finishedAt        DateTime?
  success           Boolean?
  tokensUsed        Int?
  costEstimate      Float?
  outputArtifactIds String[]     @default([])
  notes             String?     @db.Text
}

model LeadTouch {
  id              String   @id @default(cuid())
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  type            TouchType
  direction       String   // outbound | inbound
  summary         String   @db.Text
  scriptUsed      String?
  outcome         String?
  nextAction      String?  @db.Text
  nextTouchAt     DateTime?
  detailsCaptured Json?
  createdAt       DateTime @default(now())

  @@index([leadId])
}

model LeadReferral {
  id                String   @id @default(cuid())
  sourceLeadId      String
  sourceLead        Lead     @relation("ReferralsForLead", fields: [sourceLeadId], references: [id], onDelete: Cascade)
  referredName      String
  referredCompany   String?
  referredContact   String?  @db.Text
  referralQuality   Int?
  status            String   @default("new") // new | contacted | qualified | proposal_sent | won | lost
  convertedLeadId   String?
  notes             String?  @db.Text
  createdAt         DateTime @default(now())

  @@index([sourceLeadId])
}

model ContentAsset {
  id              String    @id @default(cuid())
  platform        String    // linkedin, youtube, tiktok, instagram
  title           String?
  url             String?   @db.Text
  publishedAt     DateTime?
  topicTag        String?
  format          String?
  ctaType         String?
  views           Int?
  comments        Int?
  inboundLeads    Int       @default(0)
  qualifiedLeads  Int       @default(0)
  wonDeals        Int       @default(0)
  cashCollected   Float     @default(0)
  notes           String?   @db.Text
  createdAt       DateTime  @default(now())
}

model LeadAttribution {
  id             String   @id @default(cuid())
  leadId         String
  lead           Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  contentAssetId String?
  sourceChannel  String?
  confidence     Int?
  note           String?  @db.Text
  createdAt      DateTime @default(now())

  @@index([leadId])
}

// ----- Client Acquisition Engine (Tom-style freelancer marketing) -----

/** Owned audience (newsletter/blog) ledger: manual snapshots for health + trend. */
model OwnedAudienceLedger {
  id                  String   @id @default(cuid())
  at                  DateTime // snapshot date (e.g. end of week)
  subscribers         Int      @default(0)
  sends               Int      @default(0)
  replies             Int      @default(0)
  clicks              Int      @default(0)
  inquiriesInfluenced Int      @default(0)
  note                String?  @db.Text
  createdAt           DateTime @default(now())

  @@index([at])
}

/** Networking events with quality score inputs. */
model NetworkingEvent {
  id                   String   @id @default(cuid())
  name                 String
  eventDate            DateTime
  audienceType         String?  // e.g. "tech founders", "indie devs"
  relevanceScore       Int?     // 1-10
  contactsMade         Int      @default(0)
  followUpsSent        Int      @default(0)
  opportunitiesCreated Int     @default(0)
  revenue             Float?
  notes               String?  @db.Text
  createdAt            DateTime @default(now())
}

/** NDA-safe proof assets: anonymized patterns, lessons, outcomes. No client names. */
model ProofAsset {
  id                    String   @id @default(cuid())
  anonymizedCasePattern String   @db.Text
  lessonLearned         String?  @db.Text
  outcomeSummary        String?  @db.Text
  processImprovement    String?  @db.Text
  channelContentIdeas   String[] @default([]) // e.g. "LinkedIn post on X"
  linkedArtifactIds     String[] @default([]) // proposal/content artifact IDs
  createdAt             DateTime @default(now())
}

// ----- Build Ops / Code Ops (Cloud Agent queue) -----

/** Build task: bug, feature, refactor, guardrail, template. Trackable work for Cursor Cloud Agent. */
model BuildTask {
  id                   String    @id @default(cuid())
  title                String
  type                 String    // bug | feature | refactor | guardrail | template
  priority             String    @default("medium") // low | medium | high
  linkedLeadId         String?
  linkedLead           Lead?     @relation(fields: [linkedLeadId], references: [id])
  linkedCriticismItem  String?   @db.Text  // optional ref to weekly critic item
  expectedOutcome      String?   @db.Text
  status               String    @default("todo") // todo | in_progress | review | done
  cursorPrompt         String?   @db.Text  // exact prompt given to Cloud Agent
  prSummary            String?   @db.Text  // what changed
  humanApproved        Boolean   @default(false)
  businessImpact       String?   // Acquire | Deliver | Improve
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([status])
  @@index([type])
}

// ----- Reusable Asset Log (leverage from delivered work) -----

/** Log of reusable leverage extracted from a delivered client project. Human-driven. */
model ReusableAssetLog {
  id               String   @id @default(cuid())
  leadId           String?
  lead             Lead?    @relation(fields: [leadId], references: [id])
  projectId        String?
  project          Project? @relation(fields: [projectId], references: [id])
  assetType        String   // template | component | workflow | prompt_pack | checklist | case_study | prompt_pattern | sales_script | sop_playbook
  label            String?  @db.Text  // short name or "None" when none extracted
  reasonNone       String?  @db.Text  // when no asset: reason (e.g. "one-off, not reusable")
  notes            String?  @db.Text  // what makes it reusable
  reusabilityScore Int?     // 1-5
  whereStored      String?  @db.Text  // path, link, or "Notion doc X"
  canProductize    String?  // yes | no | maybe
  createdAt        DateTime @default(now())

  @@index([leadId])
  @@index([projectId])
  @@index([createdAt])
}

// ----- Operator Copilot: approved action execution log -----

/** Log of actions executed by the operator copilot (chat approve → execute). */
model OperatorActionRun {
  id             String    @id @default(cuid())
  actionName     String
  input          Json      @default("{}")
  approvedBy     String    // User id from session
  status         String    // queued | running | success | fail
  resultSummary  String?   @db.Text
  error          String?   @db.Text
  createdAt      DateTime  @default(now())

  @@index([actionName])
  @@index([createdAt])
}

// ----- YouTube Ingestion Pipeline -----

/** YouTube source: a video or channel that was submitted for ingestion. */
model YouTubeSource {
  id             String    @id @default(cuid())
  type           String    // video | channel
  url            String
  normalizedUrl  String
  externalId     String    @unique // videoId or channelId
  title          String?
  channelName    String?
  channelId      String?
  metadataJson   Json?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  ingestJobs     YouTubeIngestJob[]
  transcripts    YouTubeTranscript[]

  @@index([type])
  @@index([externalId])
}

/** YouTube ingest job: tracks a single ingest attempt (video or channel batch). */
model YouTubeIngestJob {
  id              String    @id @default(cuid())
  sourceType      String    // video | channel
  sourceId        String?
  source          YouTubeSource? @relation(fields: [sourceId], references: [id])
  status          String    @default("PENDING") // PENDING | FETCHING | TRANSCRIBED | FAILED_TRANSCRIPT | READY_FOR_REVIEW | PROMOTED_TO_PLAYBOOK | REJECTED | KNOWLEDGE_ONLY
  attempts        Int       @default(0)
  providerUsed    String?
  lastError       String?   @db.Text
  runSummaryJson  Json?
  queuedAt        DateTime  @default(now())
  startedAt       DateTime?
  completedAt     DateTime?

  @@index([status])
  @@index([sourceId])
  @@index([queuedAt])
}

/** YouTube transcript: the actual transcript content + metadata for a video. */
model YouTubeTranscript {
  id                    String    @id @default(cuid())
  videoId               String    @unique
  channelId             String?
  sourceUrl             String
  title                 String?
  transcriptText        String    @db.Text
  transcriptSegmentsJson Json?
  language              String?
  durationSeconds       Int?
  publishedAt           DateTime?
  providerUsed          String
  transcriptHash        String?
  transcriptStatus      String    @default("TRANSCRIBED") // TRANSCRIBED | FAILED_TRANSCRIPT
  failureReason         String?   @db.Text
  metadataJson          Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  sourceRecord          YouTubeSource? @relation(fields: [videoId], references: [externalId])
  learningProposals     LearningProposal[]

  @@index([channelId])
  @@index([transcriptStatus])
  @@index([providerUsed])
}

/** Learning proposal: human-gated proposal derived from a transcript. No auto-apply. */
model LearningProposal {
  id                    String    @id @default(cuid())
  transcriptId          String
  transcript            YouTubeTranscript @relation(fields: [transcriptId], references: [id])
  summary               String    @db.Text
  extractedPointsJson   Json?
  category              String?   // sales | operations | client_delivery | positioning | ai_tooling | automation | leadership | hiring | offer_design | follow_up_retention
  systemArea            String?   // Acquire | Deliver | Improve
  contradictionFlagsJson Json?
  proposedActionsJson   Json?
  producedAssetType     String?   // proposal_template | sales_script | followup_script | objection_handling | delivery_checklist | reusable_component | case_study_angle | positioning_note | knowledge_only
  expectedImpact        String?   // acquire | deliver | improve
  revenueLink           String?   @db.Text
  status                String    @default("READY_FOR_REVIEW") // READY_FOR_REVIEW | PROMOTED_TO_PLAYBOOK | REJECTED | KNOWLEDGE_ONLY
  reviewerNotes         String?   @db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([status])
  @@index([transcriptId])
  @@index([category])
  @@index([systemArea])
}

// ----- Meta Ads Control Center V3 (recommendations + approvals + audit) -----

/** Recommendation lifecycle: queued → approved/dismissed → applied/failed | false_positive */
model MetaAdsRecommendation {
  id           String    @id @default(cuid())
  accountId    String
  entityType   String    // campaign | adset | ad
  entityId     String
  campaignId   String?   // parent campaign for adset/ad (protected check)
  entityName   String    @db.Text
  ruleKey      String
  severity     String    // info | warn | critical
  confidence   String    // low | medium | high
  status       String    // queued | approved | dismissed | applied | failed | false_positive
  actionType   String    // pause | resume | increase_budget | decrease_budget | refresh_creative | wait
  actionPayload Json     @default("{}")
  evidence     Json      @default("{}")  // spend, leads, cpl, ctr, cpc, cpm, frequency, delivery, learning
  reason       String    @db.Text
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  approvedAt   DateTime?
  appliedAt    DateTime?
  dismissedAt  DateTime?

  @@index([accountId, status, createdAt])
}

/** Audit log for every Meta Ads action (manual or rule-triggered) */
model MetaAdsActionLog {
  id               String   @id @default(cuid())
  recommendationId String?
  accountId        String
  entityType       String
  entityId         String
  entityName       String   @db.Text
  actionType       String
  actionPayload    Json     @default("{}")
  mode             String   // manual | approve_required | auto_safe | dry_run
  triggeredBy      String   // user | rule_engine
  dryRun           Boolean  @default(false)
  status           String   // success | failed | simulated | blocked
  message          String?  @db.Text
  metaResponse     Json?
  createdAt        DateTime @default(now())

  @@index([accountId, createdAt])
  @@index([accountId, entityType, entityId, createdAt])
}

/** Single row per account — automation settings and guardrails */
model MetaAdsAutomationSettings {
  id                        String   @id @default(cuid())
  accountId                 String   @unique
  mode                      String   @default("manual")  // manual | approve_required | auto_safe
  dryRun                    Boolean  @default(true)
  targetCpl                 Float?
  minSpendForDecision       Float    @default(20)
  minImpressionsForDecision Int      @default(100)
  maxBudgetIncreasePctPerAction Float @default(10)
  maxBudgetIncreasePctPerDay   Float  @default(20)
  allowChangesDuringLearning Boolean @default(false)
  protectedCampaignIds      Json     @default("[]")  // string[]
  actionCooldownMinutes     Int      @default(720)  // 12h default
  maxActionsPerEntityPerDay Int      @default(2)
  schedulerEnabled          Boolean  @default(false)
  schedulerCron             String?
  schedulerIntervalMinutes  Int      @default(60)
  autoGenerateRecommendations Boolean @default(true)
  autoApplyApprovedOnly     Boolean  @default(true)
  autoApproveLowRisk        Boolean  @default(false)
  maxAppliesPerRun          Int      @default(5)
  allowedAutoApproveRuleKeys Json    @default("[]")  // string[]
  lastSchedulerRunAt        DateTime?
  lastSchedulerRunStatus    String?
  lastSchedulerRunSummary   Json?
  alertsEnabled             Boolean  @default(false)
  alertOnSchedulerFailure   Boolean  @default(true)
  alertOnCriticalRecommendations Boolean @default(true)
  alertOnBlockedActions     Boolean  @default(false)
  alertCooldownMinutes      Int      @default(60)
  alertMinSeverity          String   @default("critical")  // warn | critical
  alertRuleKeys             Json?    // allowlist; null = all
  lastAlertSentAt           Json?    // { key -> timestamp } for cooldown
  updatedAt                 DateTime @updatedAt

  @@index([accountId])
}

/** Per-cycle scheduler run log (visibility) */
model MetaAdsSchedulerRunLog {
  id         String   @id @default(cuid())
  accountId  String
  startedAt  DateTime @default(now())
  finishedAt DateTime?
  status     String   // success | partial | failed | skipped
  trigger    String   // manual | scheduled
  dryRun     Boolean  @default(true)
  summary    Json     @default("{}")
  error      String?  @db.Text

  @@index([accountId, startedAt])
}

// ----- Planning themes (year / quarter / month) -----

/** High-level themes for planning. periodKey: "2025", "2025-Q1", "2025-01". */
model PlanningTheme {
  id         String   @id @default(cuid())
  periodType String   // year | quarter | month
  periodKey  String   // "2025" | "2025-Q1" | "2025-01"
  theme      String   @db.Text
  notes      String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([periodType, periodKey])
  @@index([periodType])
}

// ----- Strategy Quadrant (weekly planning + review) -----

/** Weekly strategy: phase, campaign, operator focus, sales target. */
model StrategyWeek {
  id                     String   @id @default(cuid())
  weekStart              DateTime // normalized Monday 00:00
  phase                  String?  // survival | formulation | explosion | plateau
  activeCampaignName     String?  @db.Text
  activeCampaignAudience String?  @db.Text
  activeCampaignChannel  String?  @db.Text
  activeCampaignOffer    String?  @db.Text
  activeCampaignCta      String?  @db.Text
  activeCampaignProof    String?  @db.Text
  operatorImprovementFocus String? @db.Text
  salesTarget            String?  @db.Text
  notes                  String?  @db.Text
  theme                  String?
  monthlyFocus           String?
  weeklyTargetValue      Decimal? @db.Decimal(18, 2)
  weeklyTargetUnit       String?
  declaredCommitment     String?  @db.Text
  // Logic + Emotion (12 Building Blocks Phase 1)
  keyMetric              String?  @db.Text
  keyMetricTarget        String?  @db.Text
  biggestBottleneck      String?  @db.Text  // planning-time / anticipated
  missionStatement       String?  @db.Text
  whyThisWeekMatters     String?  @db.Text
  dreamStatement         String?  @db.Text
  fuelStatement          String?  @db.Text
  reviewDueAt            DateTime?
  lastReviewedAt        DateTime?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  review                 StrategyWeekReview?
  targets                StrategyWeekTarget[]
  priorities             StrategyWeekPriority[]
  risks                  StrategyWeekRisk[]
  recruiting             StrategyWeekRecruitingTarget[]

  @@unique([weekStart])
  @@index([weekStart])
  @@index([phase])
}

/** End-of-week review checkmarks and notes. */
model StrategyWeekReview {
  id                  String       @id @default(cuid())
  strategyWeekId      String       @unique
  strategyWeek        StrategyWeek @relation(fields: [strategyWeekId], references: [id], onDelete: Cascade)
  campaignShipped     Boolean      @default(false)
  systemImproved      Boolean      @default(false)
  salesActionsDone    Boolean      @default(false)
  proofCaptured       Boolean      @default(false)
  biggestBottleneck   String?      @db.Text
  nextAutomation      String?      @db.Text
  score               Int?         // 0–100
  whatWorked          String?      @db.Text
  whatFailed          String?      @db.Text
  whatChanged         String?      @db.Text
  proofCapturedNotes  String?      @db.Text
  nextWeekCommitments String?      @db.Text
  completedAt         DateTime?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

model StrategyWeekTarget {
  id             String       @id @default(cuid())
  strategyWeekId String
  strategyWeek   StrategyWeek @relation(fields: [strategyWeekId], references: [id], onDelete: Cascade)
  category       String       // revenue | leads | calls | proposals | proof | custom
  name           String
  targetValue    Decimal      @db.Decimal(18, 2)
  currentValue   Decimal?     @db.Decimal(18, 2)
  unit           String       @default("count") // count | % | $
  source         String       @default("manual") // manual | internal | meta_ads | ga4 | etc
  status         String       @default("unknown") // on_track | off_track | at_risk | unknown
  sortOrder      Int          @default(100)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([strategyWeekId])
}

model StrategyWeekPriority {
  id             String       @id @default(cuid())
  strategyWeekId String
  strategyWeek   StrategyWeek @relation(fields: [strategyWeekId], references: [id], onDelete: Cascade)
  title          String
  description    String?      @db.Text
  status         String       @default("todo") // todo | in_progress | done | blocked
  priorityOrder  Int          @default(100)
  dueDate        DateTime?    @db.Date
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([strategyWeekId])
}

model StrategyWeekRisk {
  id             String       @id @default(cuid())
  strategyWeekId String
  strategyWeek   StrategyWeek @relation(fields: [strategyWeekId], references: [id], onDelete: Cascade)
  title          String
  description    String?      @db.Text
  severity       String       @default("medium") // low | medium | high
  likelihood     String       @default("medium") // low | medium | high
  responsePlan   String?      @db.Text
  status         String       @default("open") // open | monitoring | resolved
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([strategyWeekId])
}

model StrategyWeekRecruitingTarget {
  id             String       @id @default(cuid())
  strategyWeekId String
  strategyWeek   StrategyWeek @relation(fields: [strategyWeekId], references: [id], onDelete: Cascade)
  type           String       // client | partner | mentor | collaborator | hire
  name           String
  whyThisTarget  String?      @db.Text
  status         String       @default("target") // target | contacted | in_progress | won | lost
  nextAction     String?      @db.Text
  dueDate        DateTime?    @db.Date
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([strategyWeekId])
}

// ----- Internal Settings (Phase 3.4: Score Alerts) -----

/** Key-value store for internal operator config. Key is unique. */
model InternalSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  valueJson Json     @default("{}")
  updatedAt DateTime @updatedAt

  @@index([key])
}

// ----- Score Engine (Phase 3.1) -----

/** Periodic score snapshots for operational entities (reviews, command_center, etc.). */
model ScoreSnapshot {
  id          String   @id @default(cuid())
  entityType  String   // review_stream | command_center | etc.
  entityId    String
  score       Float
  band        String   // healthy | warning | critical
  delta       Float?   // difference from previous snapshot
  factorsJson Json?    // factor breakdown
  reasonsJson Json?    // top reasons
  computedAt  DateTime
  createdAt   DateTime @default(now())

  @@index([entityType, entityId, computedAt(sort: Desc)])
  @@index([band, computedAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
}

/** Significant score transitions for alerting/audit. */
model ScoreEvent {
  id          String   @id @default(cuid())
  entityType  String
  entityId    String
  eventType   String   // threshold_breach | sharp_drop | recovery
  fromScore   Float
  toScore     Float
  delta       Float
  fromBand    String
  toBand      String
  reasonsJson Json?
  dedupeKey   String?
  createdAt   DateTime @default(now())

  @@index([dedupeKey])
  @@index([entityType, entityId, createdAt(sort: Desc)])
}

// ----- Integration connections (Settings control center) -----

/// Mode = operator choice. Status = technical reality.
/// Example: mode=live + status=error means "I want live but it failed"
enum IntegrationMode {
  off
  mock
  manual
  live
}

/** Per-provider integration config. Tokens stored in configJson; no encryption in V1. */
model IntegrationConnection {
  id              String          @id @default(cuid())
  provider        String          @unique
  status          String          @default("not_connected") // not_connected | connected | error | disabled
  mode            IntegrationMode @default(off)
  category        String?         // research | outreach | content | visibility | ops | delivery | analytics
  prodOnly        Boolean         @default(false) // live only in production
  providerLabel   String?         // legacy; prefer displayName
  displayName     String?         // human-friendly label (e.g. "Google Search Console")
  helpText        String?         @db.Text // short provider guidance
  sortOrder       Int             @default(100)
  accountLabel    String?
  configJson      Json            @default("{}")
  isEnabled       Boolean         @default(true)
  notes           String?         @db.Text
  lastSyncedAt    DateTime?
  lastTestedAt    DateTime?
  lastTestStatus  String?         @default("never") // never | pass | fail
  lastError       String?         @db.Text
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([provider])
  @@index([category])
}

model IntegrationRun {
  id             String   @id @default(cuid())
  provider       String
  action         String   // test | sync | import | disconnect
  environment    String   @default("development") // development | production
  status         String   // success | error
  message        String?  @db.Text
  payloadSummary Json?
  createdAt      DateTime @default(now())

  @@index([provider])
  @@index([createdAt(sort: Desc)])
}

model ApiUsageLog {
  id              String   @id @default(cuid())
  provider        String
  action          String   // fetch | search | list | create | test | prospect
  endpoint        String?  // e.g. "GET /repos" or "POST /events"
  requestCount    Int      @default(1)
  tokensUsed      Int?     // for AI-based calls
  responseBytes   Int?
  latencyMs       Int?
  estimatedCostUsd Float?  @default(0)
  status          String   @default("success") // success | error | rate_limited
  errorMessage    String?  @db.Text
  meta            Json?
  createdAt       DateTime @default(now())

  @@index([provider])
  @@index([createdAt(sort: Desc)])
  @@index([provider, createdAt(sort: Desc)])
}

// ----- Signal Engine (RSS/News ingestion) -----

model SignalSource {
  id           String    @id @default(cuid())
  name         String
  type         String    @default("rss") // rss | atom
  url          String
  enabled      Boolean   @default(true)
  mode         IntegrationMode @default(mock)
  prodOnly     Boolean   @default(false)
  lastSyncedAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  items SignalItem[]
  logs  SignalSyncLog[]

  @@unique([url])
  @@index([enabled])
}

model SignalItem {
  id         String   @id @default(cuid())
  sourceId   String
  source     SignalSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  url        String   @unique
  title      String   @db.Text
  publishedAt DateTime?
  summary    String?  @db.Text
  rawJson    Json?
  score      Int      @default(0)
  tags       String[]
  status     String   @default("new") // new | read | archived
  createdAt  DateTime @default(now())

  @@index([sourceId])
  @@index([publishedAt(sort: Desc)])
  @@index([score])
  @@index([status])
}

model SignalSyncLog {
  id        String       @id @default(cuid())
  sourceId  String
  source    SignalSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  mode      String       // off | mock | manual | live
  status    String       // success | error
  message   String?      @db.Text
  count     Int?
  createdAt DateTime     @default(now())

  @@index([sourceId])
  @@index([createdAt(sort: Desc)])
}

// ----- Phase 1.1: Lead Intake Engine (manual-first) -----

enum IntakeLeadSource {
  upwork
  linkedin
  referral
  inbound
  rss
  other
}

enum IntakeLeadUrgency {
  low
  medium
  high
}

enum IntakeLeadStatus {
  new
  qualified
  proposal_drafted
  sent
  won
  lost
  archived
}

enum LeadActivityType {
  note
  status_change
  score
  draft
  sent
  followup
  followup_completed
  followup_snoozed
  followup_call
  followup_email
  delivery_logged
  proof_candidate_created
  proof_candidate_promoted
  pipeline_synced
  manual
}

model IntakeLead {
  id               String            @id @default(cuid())
  source           IntakeLeadSource
  title            String
  company          String?
  contactName      String?
  contactEmail     String?
  link             String?
  summary          String            @db.Text
  budgetMin        Int?
  budgetMax        Int?
  urgency          IntakeLeadUrgency @default(medium)
  status           IntakeLeadStatus  @default(new)
  score            Int?
  scoreReason      String?           @db.Text
  nextAction       String?           @db.Text
  nextActionDueAt  DateTime?
  promotedLeadId   String?           @unique
  promotedLead     Lead?             @relation(fields: [promotedLeadId], references: [id])
  proposalSentAt      DateTime?
  followUpDueAt       DateTime?
  outcomeReason       String?           @db.Text
  lastContactedAt     DateTime?
  followUpCompletedAt DateTime?
  followUpCount         Int               @default(0)
  githubUrl              String?
  loomUrl                String?
  deliverySummary        String?           @db.Text
  deliveryCompletedAt    DateTime?
  proofCandidateCount    Int               @default(0)
  tags                   String[]          @default([])
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  activities             LeadActivity[]
  proofRecords           ProofRecord[]
  proofCandidates        ProofCandidate[]
  proposalCount          Int               @default(0)
  latestProposalId       String?
  latestProposal         Proposal?         @relation("LatestProposal", fields: [latestProposalId], references: [id])
  proposals              Proposal[]
  deliveryProjects       DeliveryProject[]

  @@index([status])
  @@index([source])
  @@index([createdAt])
  @@index([nextActionDueAt])
  @@index([promotedLeadId])
}

model LeadActivity {
  id           String          @id @default(cuid())
  intakeLeadId String
  intakeLead   IntakeLead      @relation(fields: [intakeLeadId], references: [id], onDelete: Cascade)
  type         LeadActivityType
  content      String          @db.Text
  metadataJson Json?
  createdAt    DateTime        @default(now())

  @@index([intakeLeadId])
  @@index([intakeLeadId, createdAt(sort: Desc)])
}

/** Proof record from intake/won flow. Editable draft for observational proof. */
model ProofRecord {
  id                  String          @id @default(cuid())
  sourceType          String          @default("intake_lead") // intake_lead | pipeline_lead
  sourceId            String
  intakeLeadId        String?
  intakeLead          IntakeLead?     @relation(fields: [intakeLeadId], references: [id], onDelete: SetNull)
  proofCandidateId    String?         @unique
  proofCandidate      ProofCandidate? @relation(fields: [proofCandidateId], references: [id], onDelete: SetNull)
  title               String
  company             String?
  outcome             String          @default("won") // won | lost
  proofSnippet        String?         @db.Text
  beforeState         String?         @db.Text
  afterState          String?         @db.Text
  metricValue         String?
  metricLabel         String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  @@index([intakeLeadId])
  @@index([sourceType, sourceId])
  @@index([createdAt])
}

enum ProofCandidateStatus {
  draft
  ready
  promoted
  rejected
}

enum ProofCandidateTriggerType {
  github
  loom
  manual
  result_note
}

enum ProofCandidateSourceType {
  intake_lead
  pipeline_lead
  manual
}

model ProofCandidate {
  id                     String                   @id @default(cuid())
  sourceType             ProofCandidateSourceType
  sourceId               String?
  intakeLeadId           String?
  intakeLead             IntakeLead?              @relation(fields: [intakeLeadId], references: [id], onDelete: SetNull)
  leadId                 String?
  lead                   Lead?                    @relation(fields: [leadId], references: [id], onDelete: SetNull)
  title                  String
  company                String?
  triggerType            ProofCandidateTriggerType
  githubUrl              String?
  loomUrl                String?
  assetUrlsJson          Json?
  deliverySummary        String?                  @db.Text
  proofSnippet           String?                  @db.Text
  beforeState            String?                 @db.Text
  afterState             String?                 @db.Text
  metricLabel            String?
  metricValue            String?
  tags                   String[]                 @default([])
  status                 ProofCandidateStatus   @default(draft)
  readyAt                DateTime?
  promotedAt             DateTime?
  promotedProofRecordId  String?                 @unique
  promotedProofRecord    ProofRecord?
  rejectedReason         String?                 @db.Text
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  deliveryProjects       DeliveryProject[]

  @@index([status])
  @@index([sourceType])
  @@index([triggerType])
  @@index([intakeLeadId])
  @@index([createdAt])
}

// ----- Phase 2.0: Proposal Engine -----

enum ProposalStatus {
  draft
  ready
  sent
  viewed
  accepted
  rejected
  expired
}

enum ProposalPriceType {
  fixed
  range
  hourly
  custom
}

enum ProposalActivityType {
  created
  edited
  status_change
  sent
  viewed
  accepted
  rejected
  note
  followup_scheduled
  followup_completed
  followup_snoozed
  followup_email
  followup_call
  response_logged
  meeting_booked
}

enum ProposalResponseStatus {
  none
  viewed
  replied
  meeting_booked
  negotiating
  accepted
  rejected
}

model Proposal {
  id               String            @id @default(cuid())
  intakeLeadId     String?
  intakeLead       IntakeLead?       @relation(fields: [intakeLeadId], references: [id], onDelete: SetNull)
  pipelineLeadId  String?
  pipelineLead    Lead?             @relation(fields: [pipelineLeadId], references: [id], onDelete: SetNull)
  status          ProposalStatus    @default(draft)
  title           String
  clientName      String?
  clientEmail     String?
  company         String?
  summary         String?           @db.Text
  scopeOfWork     String?           @db.Text
  deliverables    Json?
  timelineDays    Int?
  priceType       ProposalPriceType?
  priceMin        Int?
  priceMax        Int?
  priceCurrency   String            @default("CAD")
  terms           String?           @db.Text
  cta             String?           @db.Text
  version         Int               @default(1)
  sentAt          DateTime?
  viewedAt        DateTime?
  respondedAt     DateTime?
  acceptedAt      DateTime?
  rejectedAt      DateTime?
  expiresAt       DateTime?
  lastEditedAt    DateTime?
  createdBy       String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  // Phase 2.1: Proposal response & follow-up
  lastContactedAt    DateTime?
  nextFollowUpAt     DateTime?
  followUpCompletedAt DateTime?
  followUpCount      Int               @default(0)
  meetingBookedAt    DateTime?
  responseStatus     ProposalResponseStatus @default(none)
  responseSummary    String?           @db.Text
  bookingUrlUsed     String?
  staleAfterDays     Int?
  finalValue         Int?            // Phase 2.3: accepted/deal value for revenue metrics
  versions        ProposalVersion[]
  activities      ProposalActivity[]
  intakeLeadsAsLatest IntakeLead[]   @relation("LatestProposal")
  deliveryProjects DeliveryProject[]

  @@index([status])
  @@index([intakeLeadId])
  @@index([pipelineLeadId])
  @@index([nextFollowUpAt])
  @@index([responseStatus])
}

model ProposalVersion {
  id           String   @id @default(cuid())
  proposalId   String
  proposal     Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  version      Int
  snapshotJson Json
  changeNote   String?  @db.Text
  createdAt    DateTime @default(now())

  @@unique([proposalId, version])
  @@index([proposalId])
}

model ProposalActivity {
  id         String               @id @default(cuid())
  proposalId String
  proposal   Proposal             @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  type       ProposalActivityType
  message    String?              @db.Text
  metaJson   Json?
  createdAt  DateTime             @default(now())

  @@index([proposalId])
  @@index([proposalId, createdAt(sort: Desc)])
}

// ----- Phase 2.0: Delivery Pipeline -----

enum DeliveryProjectStatus {
  not_started
  kickoff
  in_progress
  qa
  blocked
  completed
  archived
}

enum DeliveryMilestoneStatus {
  todo
  in_progress
  done
  blocked
}

enum DeliveryChecklistCategory {
  kickoff
  build
  qa
  handoff
  proof
}

enum DeliveryActivityType {
  created
  status_change
  milestone
  checklist
  note
  qa
  handoff
  completed
  handoff_started
  handoff_completed
  client_confirmed
  testimonial_requested
  testimonial_received
  review_requested
  review_received
  referral_requested
  referral_received
  retention_followup_scheduled
  retention_followup_completed
  retention_followup_email
  retention_followup_call
  retention_status_changed
  upsell_logged
}

enum TestimonialStatus {
  none
  requested
  received
  declined
}

enum ReferralStatus {
  none
  requested
  received
  declined
}

enum RetentionStatus {
  none
  monitoring
  followup_due
  upsell_open
  retainer_open
  closed_won
  closed_lost
}

enum PostDeliveryHealth {
  green
  yellow
  red
}

model DeliveryProject {
  id                 String                 @id @default(cuid())
  proposalId         String?
  proposal           Proposal?              @relation(fields: [proposalId], references: [id], onDelete: SetNull)
  intakeLeadId       String?
  intakeLead         IntakeLead?            @relation(fields: [intakeLeadId], references: [id], onDelete: SetNull)
  pipelineLeadId    String?
  pipelineLead      Lead?                  @relation(fields: [pipelineLeadId], references: [id], onDelete: SetNull)
  status            DeliveryProjectStatus  @default(not_started)
  title             String
  clientName        String?
  company           String?
  summary           String?                 @db.Text
  owner             String?
  startDate         DateTime?
  dueDate           DateTime?
  completedAt       DateTime?
  deliveryNotes     String?                 @db.Text
  qaNotes           String?                 @db.Text
  handoffNotes      String?                 @db.Text
  githubUrl         String?
  loomUrl           String?
  artifactUrl       String?
  proofRequestedAt DateTime?
  proofCapturedAt  DateTime?
  proofCandidateId String?
  proofCandidate   ProofCandidate?         @relation(fields: [proofCandidateId], references: [id], onDelete: SetNull)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  milestones        DeliveryMilestone[]
  checklistItems    DeliveryChecklistItem[]
  activities        DeliveryActivity[]
  // Phase 2.2: Handoff + Retention
  handoffStartedAt      DateTime?
  handoffCompletedAt   DateTime?
  handoffOwner         String?
  handoffSummary       String?              @db.Text
  clientConfirmedAt    DateTime?
  testimonialRequestedAt DateTime?
  testimonialReceivedAt  DateTime?
  testimonialStatus     TestimonialStatus   @default(none)
  testimonialQuote      String?             @db.Text
  testimonialSourceUrl  String?
  reviewRequestedAt     DateTime?
  reviewReceivedAt     DateTime?
  reviewPlatform        String?
  reviewUrl             String?
  referralRequestedAt   DateTime?
  referralReceivedAt    DateTime?
  referralStatus       ReferralStatus      @default(none)
  referralNotes        String?             @db.Text
  retentionStatus      RetentionStatus     @default(none)
  retentionNextFollowUpAt DateTime?
  retentionLastContactedAt DateTime?
  retentionFollowUpCount Int               @default(0)
  retentionOutcome     String?             @db.Text
  upsellOpportunity    String?             @db.Text
  upsellValueEstimate  Int?
  postDeliveryHealth   PostDeliveryHealth  @default(green)
  finalValue           Int?                // Phase 2.3: delivered value for revenue metrics

  @@index([status])
  @@index([dueDate])
  @@index([pipelineLeadId])
  @@index([proposalId])
  @@index([intakeLeadId])
  @@index([retentionNextFollowUpAt])
  @@index([retentionStatus])
}

model DeliveryMilestone {
  id                 String                @id @default(cuid())
  deliveryProjectId  String
  deliveryProject    DeliveryProject       @relation(fields: [deliveryProjectId], references: [id], onDelete: Cascade)
  title              String
  description        String?               @db.Text
  status             DeliveryMilestoneStatus @default(todo)
  sortOrder          Int                   @default(0)
  dueAt              DateTime?
  completedAt        DateTime?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt

  @@index([deliveryProjectId])
}

model DeliveryChecklistItem {
  id                 String                   @id @default(cuid())
  deliveryProjectId  String
  deliveryProject    DeliveryProject          @relation(fields: [deliveryProjectId], references: [id], onDelete: Cascade)
  category          DeliveryChecklistCategory
  label              String
  isRequired         Boolean                  @default(true)
  isDone             Boolean                  @default(false)
  doneAt             DateTime?
  sortOrder          Int                      @default(0)
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt

  @@index([deliveryProjectId])
}

model DeliveryActivity {
  id                 String               @id @default(cuid())
  deliveryProjectId  String
  deliveryProject    DeliveryProject      @relation(fields: [deliveryProjectId], references: [id], onDelete: Cascade)
  type               DeliveryActivityType
  message            String?               @db.Text
  metaJson           Json?
  createdAt          DateTime             @default(now())

  @@index([deliveryProjectId])
  @@index([deliveryProjectId, createdAt(sort: Desc)])
}

// ----- Phase 2.3: Revenue Intelligence -----

model WeeklyMetricSnapshot {
  id          String   @id @default(cuid())
  weekStart   DateTime
  metricKey   String
  metricGroup String
  metricLabel String
  metricValue Float
  metricCount Int?
  metaJson    Json?
  createdAt   DateTime @default(now())

  @@unique([weekStart, metricKey])
  @@index([weekStart])
  @@index([metricKey])
  @@index([metricGroup])
}

// ----- Phase 2.4: Operator Score + Forecasting -----

model OperatorScoreSnapshot {
  id            String   @id @default(cuid())
  periodType    String    // weekly | monthly
  periodStart   DateTime
  score         Int      // 0–100
  grade         String   // A, B, C, D, F
  summary       String?  @db.Text
  breakdownJson Json     @default("{}")
  createdAt     DateTime @default(now())

  @@unique([periodType, periodStart])
  @@index([periodType])
  @@index([periodStart])
}

model ForecastSnapshot {
  id            String   @id @default(cuid())
  periodType    String    // weekly | monthly
  periodStart   DateTime
  forecastKey   String
  forecastLabel String
  forecastValue Float
  confidence    String?  // low | medium | high
  metaJson      Json?
  createdAt     DateTime @default(now())

  @@unique([periodType, periodStart, forecastKey])
  @@index([periodType])
  @@index([periodStart])
  @@index([forecastKey])
}

// ----- Phase 2.5: Automation Hooks + Reminder System -----

model OpsReminder {
  id              String    @id @default(cuid())
  kind            String    // proposal_followup, intake_followup, delivery_due, proof_gap, etc.
  title           String
  description     String?   @db.Text
  status          String    @default("open") // open, snoozed, done, dismissed
  priority        String    @default("medium") // low, medium, high, critical
  dueAt           DateTime?
  snoozedUntil    DateTime?
  sourceType      String?
  sourceId        String?
  actionUrl       String?
  suggestedAction String?   @db.Text
  metaJson        Json?
  createdByRule   String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  completedAt     DateTime?
  dismissedAt     DateTime?

  @@index([status])
  @@index([dueAt])
  @@index([priority])
  @@index([sourceType, sourceId])
  @@index([status, dueAt])
  @@index([snoozedUntil])
}

model AutomationSuggestion {
  id          String    @id @default(cuid())
  type        String    // create_followup, request_testimonial, create_proof_candidate, etc.
  title       String
  reason      String    @db.Text
  status      String    @default("pending") // pending, accepted, rejected, applied, expired
  priority    String    @default("medium")
  sourceType  String?
  sourceId    String?
  payloadJson Json?
  actionUrl   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  resolvedAt  DateTime?

  @@index([status])
  @@index([priority])
  @@index([type])
  @@index([sourceType, sourceId])
}

// ----- Phase 2.7: Observability + Audit + Action Telemetry -----

enum OpsEventLevel {
  info
  warn
  error
}

enum OpsEventCategory {
  ui_action
  api_action
  page_view
  system
  audit
  automation
  integration
  data_quality
}

enum OpsEventStatus {
  started
  success
  failure
  skipped
}

model OpsEvent {
  id           String           @id @default(cuid())
  createdAt    DateTime         @default(now())
  level       OpsEventLevel     @default(info)
  category    OpsEventCategory
  status      OpsEventStatus    @default(success)
  actorType   String?
  actorId     String?
  actorLabel  String?
  eventKey    String
  eventLabel  String?
  sourceType  String?
  sourceId    String?
  route       String?
  method      String?
  requestKey  String?
  durationMs  Int?
  errorCode   String?
  errorMessage String?          @db.Text
  metaJson    Json?
  fingerprint String?

  @@index([createdAt])
  @@index([category, createdAt])
  @@index([eventKey, createdAt])
  @@index([sourceType, sourceId, createdAt])
  @@index([level, createdAt])
  @@index([fingerprint])
}

model AuditAction {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  actionKey   String
  actionLabel String
  sourceType  String
  sourceId    String
  sourceLabel String?
  beforeJson  Json?
  afterJson   Json?
  note        String?  @db.Text
  actorId     String?
  actorLabel  String?
  metaJson    Json?

  @@index([sourceType, sourceId, createdAt])
  @@index([actionKey, createdAt])
}

// ----- Phase 2.8.4: Job Queue (Postgres-backed, no Redis) -----

enum JobRunStatus {
  queued
  running
  succeeded
  failed
  canceled
  dead_letter
}

enum JobLogLevel {
  info
  warn
  error
}

model JobRun {
  id                 String       @id @default(cuid())
  jobType            String
  status             JobRunStatus @default(queued)
  priority           Int          @default(50)
  idempotencyKey     String?
  dedupeKey          String?
  payloadJson        Json?
  resultJson         Json?
  errorMessage       String?      @db.Text
  errorCode          String?
  attempts           Int          @default(0)
  maxAttempts        Int          @default(3)
  runAfter           DateTime     @default(now())
  lockedAt           DateTime?
  lockOwner          String?
  startedAt          DateTime?
  finishedAt         DateTime?
  createdByUserId    String?
  sourceType         String?
  sourceId           String?
  cancelRequestedAt  DateTime?
  canceledAt         DateTime?
  timeoutSeconds     Int?
  heartbeatAt        DateTime?
  workerVersion      String?
  deadLetteredAt     DateTime?
  lastErrorAt        DateTime?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  logs JobLog[]

  @@index([status, runAfter, priority])
  @@index([lockOwner])
  @@index([dedupeKey])
  @@index([idempotencyKey])
  @@index([jobType])
  @@index([createdAt(sort: Desc)])
}

enum JobScheduleCadenceType {
  interval
  daily
  weekly
  monthly
}

model JobSchedule {
  id                  String              @id @default(cuid())
  key                 String              @unique
  title               String
  description         String?             @db.Text
  jobType             String
  isEnabled           Boolean             @default(true)
  cadenceType         JobScheduleCadenceType
  intervalMinutes     Int?
  dayOfWeek           Int?                // 0=Sun..6=Sat
  dayOfMonth         Int?                // 1-31
  hour                Int?                // 0-23
  minute              Int?                // 0-59
  timezone            String?
  payloadTemplateJson Json?
  dedupeWindowMinutes Int?                @default(60)
  priority            Int                 @default(50)
  maxAttempts         Int                 @default(3)
  timeoutSeconds      Int?
  lastEnqueuedAt      DateTime?
  lastRunJobId        String?
  nextRunAt           DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([isEnabled, nextRunAt])
  @@index([jobType])
}

model JobLog {
  id        String     @id @default(cuid())
  jobId     String
  job       JobRun     @relation(fields: [jobId], references: [id], onDelete: Cascade)
  level     JobLogLevel @default(info)
  message   String     @db.Text
  metaJson  Json?
  createdAt DateTime   @default(now())

  @@index([jobId])
  @@index([jobId, createdAt])
}

// ----- Phase 2.8.6: Notifications + Escalations -----

enum NotificationChannelType {
  in_app
  webhook
  email
  discord_webhook
}

enum NotificationSeverity {
  info
  warning
  critical
}

enum NotificationEventStatus {
  pending
  queued
  sent
  failed
  suppressed
}

enum NotificationDeliveryStatus {
  queued
  sending
  sent
  failed
  skipped
}

model NotificationChannel {
  id               String                 @id @default(cuid())
  key              String                 @unique
  title            String
  type             NotificationChannelType
  isEnabled        Boolean                @default(true)
  isDefault        Boolean                @default(false)
  severityMin      NotificationSeverity?
  configJson       Json?
  secretRef        String?
  lastTestedAt     DateTime?
  lastSuccessAt    DateTime?
  lastErrorAt      DateTime?
  lastErrorMessage String?                @db.Text
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  deliveries NotificationDelivery[]

  @@index([isEnabled])
  @@index([type])
}

model NotificationEvent {
  id            String                 @id @default(cuid())
  eventKey      String
  title         String
  message       String                 @db.Text
  severity      NotificationSeverity
  sourceType    String?
  sourceId      String?
  actionUrl     String?
  metaJson      Json?
  dedupeKey     String?
  status        NotificationEventStatus @default(pending)
  occurredAt    DateTime
  queuedAt      DateTime?
  sentAt        DateTime?
  failedAt      DateTime?
  errorMessage  String?                @db.Text
  createdByRule String?
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  deliveries         NotificationDelivery[]
  inAppNotification InAppNotification?

  @@index([status])
  @@index([severity])
  @@index([occurredAt(sort: Desc)])
  @@index([sourceType, sourceId])
  @@index([dedupeKey])
}

model NotificationDelivery {
  id                   String                    @id @default(cuid())
  notificationEventId  String
  notificationEvent    NotificationEvent         @relation(fields: [notificationEventId], references: [id], onDelete: Cascade)
  channelId            String
  channel              NotificationChannel       @relation(fields: [channelId], references: [id], onDelete: Cascade)
  status               NotificationDeliveryStatus @default(queued)
  attempt              Int                       @default(0)
  maxAttempts          Int                       @default(3)
  runAfter             DateTime?
  queuedJobRunId       String?
  providerMessageId    String?
  requestPayloadJson   Json?
  responsePayloadJson  Json?
  sentAt               DateTime?
  failedAt             DateTime?
  errorCode            String?
  errorMessage         String?                   @db.Text
  dedupeKey            String?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt

  @@index([status, runAfter])
  @@index([channelId, status])
  @@index([notificationEventId])
  @@index([dedupeKey])
}

model InAppNotification {
  id                  String             @id @default(cuid())
  notificationEventId String?            @unique
  notificationEvent   NotificationEvent? @relation(fields: [notificationEventId], references: [id], onDelete: SetNull)
  title               String
  message             String             @db.Text
  severity            NotificationSeverity
  actionUrl           String?
  isRead              Boolean            @default(false)
  readAt              DateTime?
  createdAt           DateTime           @default(now())

  @@index([isRead])
  @@index([createdAt(sort: Desc)])
}

model EscalationRule {
  id                  String               @id @default(cuid())
  key                 String               @unique
  title               String
  isEnabled           Boolean              @default(true)
  sourceType          String
  triggerType         String
  severity            NotificationSeverity
  delayMinutes        Int                  @default(0)
  dedupeWindowMinutes Int                  @default(60)
  channelTargetsJson  Json?
  conditionsJson      Json?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  @@index([isEnabled])
  @@index([sourceType, triggerType])
}

// ----- Phase 4.0: Risk Flags + Next Best Action -----

enum RiskSeverity {
  low
  medium
  high
  critical
}

enum RiskStatus {
  open
  snoozed
  resolved
  dismissed
}

enum RiskSourceType {
  intake_lead
  proposal
  delivery_project
  proof_candidate
  reminder
  notification_event
  job
  score
  system
}

model RiskFlag {
  id            String       @id @default(cuid())
  key           String // unique per kind+scope, used for dedupe
  title         String
  description   String?      @db.Text
  severity      RiskSeverity
  status        RiskStatus   @default(open)

  sourceType    RiskSourceType
  sourceId      String? // nullable for system-wide risks
  actionUrl     String?      @db.Text // where to fix it
  suggestedFix  String?      @db.Text // short recommended remediation

  evidenceJson  Json? // structured evidence (counts, ids, dates)
  createdByRule String
  dedupeKey     String       @unique
  lastSeenAt    DateTime
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  resolvedAt    DateTime?
  snoozedUntil  DateTime?

  @@index([severity, status, lastSeenAt(sort: Desc)])
  @@index([sourceType, sourceId])
}

enum NextActionPriority {
  low
  medium
  high
  critical
}

enum NextActionStatus {
  queued
  done
  dismissed
}

model NextBestAction {
  id            String            @id @default(cuid())
  title         String
  reason        String?           @db.Text
  priority      NextActionPriority
  score         Int // 0-100, ranking score
  status        NextActionStatus  @default(queued)

  sourceType    RiskSourceType
  sourceId      String?
  actionUrl     String?           @db.Text
  payloadJson   Json? // what to do (read-only in 4.0)
  createdByRule String
  dedupeKey     String            @unique

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  completedAt  DateTime?
  dismissedAt  DateTime?

  @@index([priority, status, createdAt(sort: Desc)])
  @@index([sourceType, sourceId])
}

model NextActionRun {
  id        String   @id @default(cuid())
  runKey    String   @unique // e.g. day bucket, per-user run, etc.
  mode      String // manual|auto
  createdAt DateTime @default(now())
  metaJson  Json?
}
